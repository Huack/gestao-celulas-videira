<!DOCTYPE html>
<html class="light" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Home do Visitante - Igreja Videira</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#d41152",
                        "accent-gold": "#C5A059",
                        "background-light": "#f8f6f6",
                        "background-dark": "#221016",
                    },
                    fontFamily: { "display": ["Inter"] },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: 100dvh;
        }

        .ios-tab-bar {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#1b0d12] dark:text-[#fcf8f9] antialiased">
    <div class="relative flex h-screen w-full flex-col overflow-x-hidden">
        <header
            class="flex items-center bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md sticky top-0 z-50 p-4 justify-between border-b border-gray-200 dark:border-white/10">
            <div class="text-primary flex size-10 shrink-0 items-center justify-center">
                <span class="material-symbols-outlined">menu</span>
            </div>
            <div class="flex flex-col items-center">
                <h2 class="text-[#1b0d12] dark:text-[#fcf8f9] text-sm font-bold leading-tight tracking-tight uppercase">
                    Igreja Videira</h2>
                <span class="text-[10px] text-accent-gold font-semibold tracking-widest uppercase">Visitante</span>
            </div>
            <a href="perfil.html"
                class="flex items-center justify-center rounded-full size-10 bg-transparent text-[#1b0d12] dark:text-[#fcf8f9] no-underline">
                <span class="material-symbols-outlined">account_circle</span>
            </a>
        </header>
        <main class="flex-1 pb-24 overflow-y-auto">
            <!-- Dynamic greeting based on user name -->
            <div id="greetingSection" class="px-4 pt-4 pb-2 hidden">
                <h2 class="text-[#1b0d12] dark:text-[#fcf8f9] text-xl font-bold">
                    Ol√°, <span id="userName" class="text-primary"></span> üëã
                </h2>
                <p class="text-gray-500 text-sm">Que bom ter voc√™ de volta!</p>
            </div>

            <!-- RETURNING VISITOR: Last visited cell card -->
            <div id="returnVisitorCard" class="px-4 py-3 hidden">
                <div class="bg-white dark:bg-white/5 border border-primary/20 rounded-xl overflow-hidden shadow-lg">
                    <!-- Header -->
                    <div
                        class="bg-primary/5 dark:bg-primary/10 px-5 py-3 flex items-center gap-3 border-b border-primary/10">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-primary text-lg">replay</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-primary uppercase tracking-wider">Visite novamente</p>
                            <p class="text-[10px] text-gray-500">Sua √∫ltima c√©lula visitada</p>
                        </div>
                    </div>
                    <!-- Cell Info -->
                    <div class="p-5">
                        <h3 id="lastCellName" class="text-[#1b0d12] dark:text-[#fcf8f9] text-lg font-bold mb-1"></h3>
                        <p id="lastCellLeader" class="text-gray-500 text-sm mb-3"></p>
                        <div id="lastCellTags" class="flex flex-wrap gap-2 mb-4"></div>
                        <div class="flex gap-3">
                            <a href="encontrar-celula.html"
                                class="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-primary flex items-center justify-center gap-2 no-underline transition-all hover:bg-primary/90 active:scale-[0.98]">
                                <span class="material-symbols-outlined text-lg">directions</span>
                                Quero visitar de novo
                            </a>
                            <a href="encontrar-celula.html"
                                class="py-3 px-4 rounded-xl text-sm font-semibold text-gray-500 border border-gray-200 dark:border-white/10 flex items-center justify-center no-underline hover:bg-gray-50 dark:hover:bg-white/5">
                                <span class="material-symbols-outlined text-lg">explore</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW VISITOR: Hero banner -->
            <div id="newVisitorSection">
                <div class="@container px-4 py-4">
                    <div class="relative bg-cover bg-center flex flex-col justify-end overflow-hidden rounded-xl min-h-[280px] shadow-lg group"
                        style='background-image: linear-gradient(180deg, rgba(0, 0, 0, 0) 40%, rgba(0, 0, 0, 0.8) 100%), url("https://lh3.googleusercontent.com/aida-public/AB6AXuDP1hl5mIilLcNXvWZEt3ZOlerBVLaOyvO8fx6m8u6HNeobkPiCrWOcbCYavd5S-8au8IImHDg0KmMEQjLdeZk-OgdJ-6zySA8apSVKBXGINe8KugsV-Co1w0zqEWDQ_lIblly4U6RBlemjB_kaOBXMsqmDIQK24tyMPoJE29L9JnB4xaN0AZ2Nl8f7uQjwdEwW4xbuihakw33ERBkUOCi-w-Evq6oOVfTas4A9z7oZZTxsZSi2U7BZZR7An_G7NBYaiY6wEX3iFTmP");'>
                        <div class="p-6">
                            <p class="text-accent-gold text-xs font-bold uppercase tracking-[0.2em] mb-1">Seja Bem-vindo
                            </p>
                            <h1 class="text-white text-3xl font-bold leading-tight mb-2">Sua nova fam√≠lia come√ßa aqui.
                            </h1>
                            <p class="text-white/80 text-sm font-medium">Conecte-se com pessoas que amam a Deus.</p>
                        </div>
                    </div>
                </div>

                <!-- CHOSEN CELL CARD (shown when user chose a cell on first access) -->
                <div id="chosenCellCard" class="px-4 py-2 hidden">
                    <div
                        class="bg-white dark:bg-white/5 border border-green-500/20 rounded-xl overflow-hidden shadow-md">
                        <div
                            class="bg-green-500/5 dark:bg-green-500/10 px-5 py-3 flex items-center gap-3 border-b border-green-500/10">
                            <div class="w-8 h-8 rounded-full bg-green-500/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-green-600 dark:text-green-400 text-lg"
                                    style="font-variation-settings: 'FILL' 1">check_circle</span>
                            </div>
                            <div>
                                <p
                                    class="text-xs font-bold text-green-700 dark:text-green-400 uppercase tracking-wider">
                                    Sua C√©lula</p>
                                <p class="text-[10px] text-gray-500">Voc√™ escolheu participar desta c√©lula</p>
                            </div>
                        </div>
                        <div class="p-5">
                            <h3 id="chosenCellName" class="text-[#1b0d12] dark:text-[#fcf8f9] text-lg font-bold mb-1">
                            </h3>
                            <p id="chosenCellLeader" class="text-gray-500 text-sm mb-3"></p>
                            <div id="chosenCellTags" class="flex flex-wrap gap-2 mb-4"></div>
                            <div class="flex gap-3">
                                <a href="encontrar-celula.html"
                                    class="flex-1 py-3 rounded-xl text-sm font-bold text-white bg-primary flex items-center justify-center gap-2 no-underline transition-all hover:bg-primary/90 active:scale-[0.98]">
                                    <span class="material-symbols-outlined text-lg">directions</span>
                                    Como chegar
                                </a>
                                <a href="escolher-celula.html"
                                    class="py-3 px-4 rounded-xl text-sm font-semibold text-gray-500 border border-gray-200 dark:border-white/10 flex items-center justify-center no-underline hover:bg-gray-50 dark:hover:bg-white/5">
                                    <span class="material-symbols-outlined text-lg">swap_horiz</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOCALIZAR CELULA (shown only when user skipped cell choice) -->
                <div id="localizarCelula" class="px-4 py-2">
                    <a href="encontrar-celula.html"
                        class="w-full flex items-center justify-between bg-primary hover:bg-primary/90 text-white rounded-xl p-5 shadow-md transition-all active:scale-[0.98] no-underline">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 p-2 rounded-lg">
                                <span class="material-symbols-outlined text-white">map</span>
                            </div>
                            <div class="text-left">
                                <span class="block text-lg font-bold">Localizar C√©lula</span>
                                <span class="block text-xs text-white/70">Encontre um grupo perto de voc√™</span>
                            </div>
                        </div>
                        <span class="material-symbols-outlined">chevron_right</span>
                    </a>
                </div>
            </div>

            <div class="px-4 py-4">
                <div
                    class="bg-white dark:bg-white/5 border border-accent-gold/30 rounded-xl p-6 shadow-sm relative overflow-hidden">
                    <div class="absolute top-3 right-4 text-accent-gold/20 pointer-events-none font-bold text-2xl tracking-tight"
                        id="diaDoAnoLabel"></div>
                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-symbols-outlined text-accent-gold text-xl">auto_stories</span>
                        <h3 class="text-[#1b0d12] dark:text-[#fcf8f9] text-sm font-bold uppercase tracking-wider">
                            Vers√≠culo do Dia</h3>
                    </div>
                    <p id="versiculoTexto"
                        class="text-lg italic font-medium leading-relaxed text-[#1b0d12] dark:text-[#fcf8f9] mb-4"></p>
                    <div class="flex items-center justify-between">
                        <span id="versiculoRef" class="text-primary font-bold text-sm"></span>
                        <button onclick="compartilharVersiculo()"
                            class="flex items-center gap-1 text-accent-gold font-semibold text-xs border border-accent-gold/30 px-3 py-1 rounded-full">
                            <span class="material-symbols-outlined text-sm">share</span> Compartilhar
                        </button>
                    </div>
                </div>
            </div>
            <div class="px-4 py-2">
                <h3 class="text-[#1b0d12] dark:text-[#fcf8f9] text-lg font-bold mb-4 px-1">Pr√≥ximos Passos</h3>
                <div class="grid grid-cols-2 gap-4">
                    <a id="falarComLider" href="boas-vindas/mensagem.html"
                        class="bg-white dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/5 flex flex-col gap-3 shadow-sm no-underline hidden">
                        <div class="bg-primary/10 size-10 rounded-lg flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined">chat_bubble</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-sm">Falar com L√≠der</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Tire suas d√∫vidas agora</p>
                        </div>
                    </a>
                    <a href="boas-vindas/kit-digital.html"
                        class="bg-white dark:bg-white/5 p-4 rounded-xl border border-gray-100 dark:border-white/5 flex flex-col gap-3 shadow-sm no-underline">
                        <div
                            class="bg-accent-gold/10 size-10 rounded-lg flex items-center justify-center text-accent-gold">
                            <span class="material-symbols-outlined">visibility</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-sm">Nossa Vis√£o</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Conhe√ßa nossa hist√≥ria</p>
                        </div>
                    </a>
                </div>
            </div>
            <div class="px-4 py-6">
                <div class="bg-accent-gold/5 rounded-xl p-5 border border-accent-gold/20 flex items-center gap-4">
                    <div class="flex-1">
                        <h4 class="text-accent-gold font-bold text-sm uppercase tracking-tight mb-1">Nossos Cultos</h4>
                        <p class="text-[#1b0d12] dark:text-[#fcf8f9] text-sm font-semibold">Domingos √†s 10h, 17h e 19h
                        </p>
                        <p class="text-gray-500 text-xs mt-1">Av. T-7, Setor Bueno</p>
                    </div>
                </div>
        </main>
        <!-- Bottom Navigation removed by bottom-nav.js -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/data-service.js"></script>
    <script src="../js/versiculos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ‚îÄ‚îÄ Vers√≠culo do Dia ‚îÄ‚îÄ
            const versiculo = getVersiculoDoDia();
            document.getElementById('versiculoTexto').textContent = '"' + versiculo.texto + '"';
            document.getElementById('versiculoRef').textContent = versiculo.ref;

            // Day of year counter
            const hoje = new Date();
            const inicioAno = new Date(hoje.getFullYear(), 0, 0);
            const diaDoAno = Math.floor((hoje - inicioAno) / (1000 * 60 * 60 * 24));
            const isLeap = (y) => (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
            const totalDias = isLeap(hoje.getFullYear()) ? 366 : 365;
            document.getElementById('diaDoAnoLabel').textContent = diaDoAno + '/' + totalDias;

            // ‚îÄ‚îÄ Visitor flow logic (async via DataService) ‚îÄ‚îÄ
            (async function () {
                const lastCell = await DataService.cell.getLastVisited();
                const userName = await DataService.user.getName();
                const isFirstAccess = await DataService.user.isFirstAccess();
                const skippedCell = await DataService.cell.hasSkippedChoice();

                // Show personalized greeting if we have a name
                if (userName) {
                    document.getElementById('greetingSection').classList.remove('hidden');
                    document.getElementById('userName').textContent = userName;
                }

                if (isFirstAccess) {
                    // ‚îÄ‚îÄ FIRST ACCESS ‚îÄ‚îÄ
                    if (lastCell && !skippedCell) {
                        // User CHOSE a cell ‚Üí show "Sua C√©lula" card, hide "Localizar"
                        try {
                            const cellData = lastCell; // already parsed by DataService
                            document.getElementById('chosenCellCard').classList.remove('hidden');
                            document.getElementById('localizarCelula').classList.add('hidden');
                            document.getElementById('chosenCellName').textContent = cellData.name;
                            document.getElementById('chosenCellLeader').textContent = cellData.leader;
                            populateTags('chosenCellTags', cellData.tags);
                        } catch (e) {
                            console.error('Error parsing cell data:', e);
                        }
                    }
                    // User SKIPPED ‚Üí "Localizar C√©lula" stays visible (default)

                    // Clear first access flag so next login ‚Üí returning flow
                    DataService.user.setFirstAccess(false);
                    DataService.cell.setSkippedChoice(false);

                } else if (lastCell) {
                    // ‚îÄ‚îÄ RETURNING VISITOR ‚îÄ‚îÄ
                    try {
                        const cellData = lastCell; // already parsed by DataService
                        document.getElementById('returnVisitorCard').classList.remove('hidden');
                        document.getElementById('newVisitorSection').classList.add('hidden');
                        document.getElementById('lastCellName').textContent = cellData.name;
                        document.getElementById('lastCellLeader').textContent = cellData.leader;
                        populateTags('lastCellTags', cellData.tags);
                    } catch (e) {
                        console.error('Error parsing cell data:', e);
                    }
                }

                // Show "Falar com L√≠der" only when user has a cell linked
                if (lastCell) {
                    document.getElementById('falarComLider').classList.remove('hidden');
                }

                function populateTags(containerId, tags) {
                    const container = document.getElementById(containerId);
                    if (tags && tags.length > 0) {
                        tags.forEach(tag => {
                            const span = document.createElement('span');
                            span.className = 'inline-flex items-center gap-1 text-[10px] text-gray-500 bg-gray-100 dark:bg-white/5 px-2.5 py-1 rounded-full';
                            span.textContent = tag;
                            container.appendChild(span);
                        });
                    }
                }
            })();

            function compartilharVersiculo() {
                const v = getVersiculoDoDia();
                const texto = `"${v.texto}" ‚Äî ${v.ref}`;
                if (navigator.share) {
                    navigator.share({ title: 'Vers√≠culo do Dia', text: texto });
                } else {
                    navigator.clipboard.writeText(texto).then(() => {
                        alert('Vers√≠culo copiado!');
                    });
                }
            }
        });
    </script>
    <script src="../js/bottom-nav.js"></script>
</body>

</html>